= How to set up XL Release in production
:sectnums:
:toc2: right
:page-liquid:
:page-categories: [xl-release]
:page-subject: Installation
:page-tags: [production, setup, installation]

== Introduction
To run XL Release in a highly available production setup, you need to properly configure the product, environment and server resources to get the most out of the product. This document provides a step-by-step implementation guide to set up XL Release in a production ready environment.

CAUTION: Proper configuration of I/O subsystems (database, file system, network) is critical for the optimal performance and operation of XL Release. This guide provides best practices and sizing recommendations.

This guide is broken up into several phases each covering several topics needed to know to install a production environment.

== Setup of production environment
This guide will describe how to setup a hardened production environment for XL Release. The setup that is described can be explained using the following deployment diagram:

image::../../images/xl-prod-diagram.png[,800,,align="center"]

In the above diagram you can see the following components from left to right:

- The user's computer: The user will initiate an SSL (secure) connection to the loadbalancer which fronts the clustered XL Release installation.
- The loadbalancer: The loadbalancer terminates the SSL connection and routes the request to the XL Release instance that the user is logged in to.
- The XL Release instances: The instances run in a clustered (Active/Active) setup, sharing the load.
- The OIDC (Open ID Connect) provider will authenticate users logging into the XL Release systems. Instead of an OIDC provider, XL Release also has support for LDAP(s).
- The Database: The (SQL) database that will host the repository of the XL Release instances.

== Structure of the document
This document is structured into 3 phases:

- Preparation
- Installation
- Administration

In the preparation phase the prerequisites are described for the XL Release setup. In the installation phase, the setup and configuration procedures for each of the components is described. Finally, in the administration section, best practices will be described to maintain and administer the system once it is in production.

== Preparation
The first phase of setting up the production environment consists of determining the correct hardware requirements and obtaining all the necessary prerequisites.

=== Obtaining the XL-Release servers
In the link:../concept/requirements-for-installing-xl-release.html[requirements for installing XL Release] guide, the minimal system requirements are defined on which XL Release can run. For a production setup we recommend the following setup for each production XL Release machine:

Hardware requirements XL Release servers:

- **3+ Ghz 2 CPU Quad-core** machine (amounting to 8 cores) or better.
- **16 GB RAM** or more
- **500GB** harddisk space

XebiaLabs has performance tested XL Release 7.5.0 with this setup. TODO

XL Release supports both Microsoft Windows and Linux/Unix operating systems to run on. Any 64-bit version of Windows works. Ensure that whichever Operating System you run, you are always running the latest security updates.

Furthermore XL Release requires **Java8**. Both the Oracle JDK or JRE, as well as OpenJDK are supported. Again, please always run the latest patch level of the JDK/JRE unless otherwise instructed.

NOTE: All the XL Release cluster nodes _should_ reside in the same network segment. This is required for the clustering protocol to function correctly. For optimal performance it is also recommended to put the database server in the same network segment to minimize network latency.

=== Choosing your database server
For a production setup you need to use an external (clustered) database to store both the active as well as the archived data of XL Release. You have the choice of the following database to store the repository in:

- Oracle 11g
- Oracle 12c
- PostgreSQL versions 9.3, 9.4, 9.5, 9.6, and 10.1
- MySQL versions 5.5, 5.6, and 5.7
- Microsoft SQL Server 2012 and later
- DB2 versions 10.5 and 11.1

Please refer to the relevant documentation of the database server of your choice for hardware recommendations.

=== Choosing your loadbalancer
In order to run an HA setup of XL Release, you need to front the installation with a loadbalancer so that users are unaware of which of the clustered nodes they're being routed to. The example configuration given in this document is for HAProxy.
However any HTTP(s) loadbalancer that supports the following features is supported for following this guide:

- SSL offloading
- Checking a custom HTTP endpoint for node availability
- Sticky sessions

Loadbalancers that support this feature set are (not limited to):

- link:https://www.citrix.com/products/netscaler-adc/[Citrix NetScaler]
- link:https://f5.com/products/big-ip[F5 BIG-IP]
- link:http://www.haproxy.org/[HAProxy]

=== Choosing your authentication provider
XL Release has support for a number of (SSO) authentication providers. In its most basic form, there is support for LDAPS (Secure LDAP). However for modern environments, there is also support for authentication through an link:http://openid.net/connect/[OIDC provider].

A large number of cloud providers have support for authenticating through OIDC:

- link:https://developers.google.com/identity/protocols/OpenIDConnect[Google Identity Platform]
- link:https://docs.microsoft.com/en-us/azure/active-directory/develop/active-directory-protocols-openid-connect-code#register-your-application-with-your-ad-tenant[Microsoft Azure Active Directory (Office 365)]
- link:https://developer.okta.com/docs/api/resources/oidc.html#openid-connect-api[OKTA Identity provider]

If you don't want to depend on a cloud provider, or your SSO solution is not compatible with OIDC, it is possible to integrate your SSO with link:http://www.keycloak.org[Keycloak], which is an OIDC bridge.

=== Choosing your proactive monitoring and alerting solution
For a production installation XebiaLabs recommends setting up a proactive monitoring system to monitor system and product performance for the different parts of your installation. XL Release exposes internal and system metrics over JMX. Any monitoring system that can read JMX data can be sed to monitor the installation.

Typical monitoring and alerting tools that can be hooked up to XL Release are:

- link:https://www.nagios.org/[Nagios]
- link:https://www.dynatrace.com/[Dynatrace]
- link:https://www.appdynamics.com/[AppDynamics]

These tools allow to monitor the product and the systems it is running on in real time. This will allow you to set thresholds and alert on them so that appropriate action can be taken before a system goes down.

=== Choosing your forensic data gathering toolchain
Next to doing proactive monitoring, for a production installation it is good practice to have data gathering available. When gathering forensic data you can analyze this at a later point in time. This gathered data can be used to determine root cause analysis for outages. It can also be used to determine usage patterns or peak load patterns.

For this kind of monitoring a timeseries database is typically used. XL Release can be hooked up to either:

- link:https://www.influxdata.com/time-series-platform/influxdb/[InfluxDB]
- link:https://prometheus.io/[Prometheus]

The gathered data can then be graphed and analyzed using tools such as link:https://grafana.com[Grafana]

Next to system monitoring, another set of tools that are useful for forensic data analysis is the ELK stack.

=== Log file analysis
The third kind of monitoring that should be hooked up to a production system is log file monitoring. An industry standard stack for this is the ELK stack. This stack consists of:

- link:https://elastic.co[Elasticsearch]
- link:https://www.elastic.co/products/logstash[Logstash]
- link:https://www.elastic.co/products/kibana[Kibana]

This stack will read and index the log files while they're being written, so that they can be easily analyzed during a root cause analysis for a production outage.

== Execution phase
Once all the machines in the production environment are available, XL Release and subsystems can be installed and activated.

=== Setup the database server
XL Release requires two separate schemas in the target database platform. Typically schemas are tied to users by default. XL Release will use the main schema to store its active data in. The second schema is used to store the compliancy / archived (immutable) data in.

For this guide we will create the following users and schemas:

- `xlrelease`: This will be the user/schema for the active release data.
- `xlrarchive`: This will be the user/schema for the compliance release data. This schema will over time grow in size.

For some of the databases some extra configuration options need to be set for them to be supported or to perform better.

==== DB2
XL Release requires that DB2 is set in MySQL compatible mode in order for it to support the pagination queries. Please run the following command on your DB2 database to enable this:

[source,console]
----
$ db2set DB2_COMPATIBILITY_VECTOR=MYS
$ db2stop
$ db2start
----

==== MySQL / MariaDB
The default installation of MySQL is not tuned to be run on a dedicated high-end machine. XebiaLabs recommends changing the following settings of MySQL to improve its performance. These settings can be set in the MySQL options file. See the link:https://dev.mysql.com/doc/refman/5.7/en/option-files.html[MySQL documentation] to locate this file on your operating system.

[cols="^,2",options="header"]
|===
| Setting | Value
| `innodb_buffer_pool_size` | XebiaLabs recommends setting this to 70-75% of the available RAM of the database server, but not higher. This setting controls how much of the database structure can be kept in memory. The larger it is, the better performant the application will be due to caching at the database level.
| `innodb_log_file_size` | XebiaLabs recommends setting this to `256M`. This setting controls how much redo logs MySQL keeps. This setting should be set large enough so that MySQL can smooth out peak loads by keeping transactions in the redo log.
| `innodb_thread_concurrency` | XebiaLabs recommends setting this to `2 * CPU cores` of the database server. So for a 2 CPU Quad-core machine, this setting should be set to `2 CPU * 4 Cores * 2 = 16`.
| `max_allowed_packet` | XebiaLabs recommends setting this value to `16M`. This setting controls how large the packet can be that the server transmits to the client. As the XL Release database for some columns works with BLOBs, this setting is recommended over the default of `1M`.
| `open_files_limit` | XebiaLabs recommends setting this value to `10000` for large installations. This setting controls how many file descriptors the MySQL database can keep open. This setting cannot be configured higher than the output of `ulimit -n` on a Linux/Unix system. Please refer to the documentation of your operating system if this limit is lower than the recommended value.
| `innodb_flush_log_at_trx_commit` a| **Advanced**: The default setting of this option is `1` which means that every transaction is always flushed to disk on commit, ensuring full ACID compliance. Setting this to either `0` (only flush the transaction buffer once per second to the transaction log), or `2` (directly write the transaction to the transaction log, flush the log once per second to disk), can lead to transaction loss of up to a second worth of data.

When using battery backed disk-cache, this setting can be set to `2` to prevent direct flushes to disk. The battery backed disk-cache will then ensure that the cache is flushed to disk before the power fails.
|===

==== PostgreSQL
There are a number of settings in a default installation of PostgreSQL that can be tuned to better perform on higher end systems. These configuration options can be set in the PostgreSQL configuration file. See the link:https://www.postgresql.org/docs/9.6/static/runtime-config-file-locations.html[PostgreSQL documentation] to locate this file on your operating system.


[cols="^,2",options="header"]
|===
| Setting | Value
| `shared_buffers` | XebiaLabs recommends setting this to 30% of the available RAM of the database server. This setting controls how much memory is dedicated to PostgreSQL to use for caching data.
| `effective_cache_size` | XebiaLabs recommends setting this to 50% of the available RAM of the database server. This setting provides an estimate of how much memory is available for disk caching. The PostgreSQL query planner uses this to figure out whether query plan results would fit in memory or not.
| `checkpoint_segments` | Xebialabs recommends setting this to `64`. This setting controls how often the Write Ahead Log (WAL) is checkpointed. The WAL is written in 16MB segments. Setting this to `64` means that either once every `64 * 16MB = 1024MB` or once per 5 minutes the WAL is checkpointed, whichever is reached first.
| `default_statistics_target` | XebiaLabs recommends setting this to `250`. This setting controls the amount of information stored in the statistics tables for optimizing query execution.
| `work_mem` | XebiaLabs recommends setting this to 0.2% of the available RAM of the database server. This setting controls how much memory is available per connection for doing in memory sorts and joins of query results. In a 100 connection scenario this will amount to 20% of the available RAM in total.
| `maintenance_work_mem` | XebiaLabs recommends setting this to 2% of the available RAM. This setting controls the amount of memory available to PostgreSQL for maintenance operations such as VACUUM and ANALYZE.
| `synchronous_commit` | **Advanced**: The default setting of this option is `on`, this guarantees full ACID compliance and no data-loss on power failure. If you have a battery-backed disk cache, you can switch this setting to `off` to get an increase in transactions per second.
|===

=== Setup of the XL Release environment
As XL Release has the potential of running both remote and local script tasks, you need to take care to harden the XL Release environment from (accidental) abuse. There are many industry standard practices to ensure that an app is running in a sandboxed environment. At the very least we recommend taking the following actions:

==== Installation
This section describes how to install XL Release on the machines so that it is installed with minimum rights.

. Create a dedicated _non-root_ user called `xl-release`. This ensures that you can lock down the operating system and prevents accidental privilege escalations.
. Create a directory under `/opt` called `xebialabs`, where the `xl-release` user has _read_ access.
. Extract a clean version of XL Release in the `/opt/xebialabs` directory.
. Change the ownership of the installed product to `xl-release`, and grant the user _read_ access to the installation directory.
. Grant the `xl-release` user _write_ access to the `/opt/xebialabs/xl-release-<version>-server/conf` and `/opt/xebialabs/xl-release-<version>-server/log` directories.
. Copy your license file, obtained from link:https://dist.xebialabs.com/customer/license[the XebiaLabs distribution site] to the `/opt/xebialabs/xl-release-<version>-server/conf` directory.

==== Configuration of the SQL Repository
For a clustered production setup XL Release requires than an external database is configured. This is documented in the following guide:

- link:configure-the-xl-release-sql-repository-in-a-database.html[How to configure the XL Release SQL repository in a database]

==== Configuration of the XL Release clustering
To configure XL Release in a clustered active/active setup, please read the following guide:

- link:configure-cluster.html[How to configure cluster mode]

==== Configuration of user authentication
Next to the cluster and database configuration, you will also need to setup a secure way of authenticating the user. For production setups, XebiaLabs recommends using either an OIDC provider, or an LDAP directory system over the **LDAPS** protocol. For setting these up, please refer to the following configuration guides:

- link:../concept/xl-release-oidc-authentication.html[Configure Open ID Connect authentication for XL Release]
- link:configure-ldap-security-for-xl-release.html[Configure LDAP security for XL Release]

==== Configuration of the XL Release JVM options
By default XL Release is configured to provide a good out of the box trial experience. For optimal production use, the runtime configuration of XL Release needs to be configured. XebiaLabs recommends adding/changing the following settings in the `conf/xlr-wrapper-linux.conf`

[cols="^,2",options="header"]
|===
| Setting | Value
| `-server` | Instructs the JVM to run in the server profile
| `-Xms8192m` | Instructs the JVM to reserve a minimum of 8GB of Heap space
| `-Xmx8192m` | Instructs the JVM to reserve a maximum of 8GB of Heap space
| `-XX:+UnlockExperimentalVMOptions` | Instructs the JVM to unlock experimental options
| `-XX:MaxMetaspaceSize=1024m` | Instructs the JVM to assign 1GB of memory to the Metaspace region (off-heap memory region for loading classes and native libraries)
| `-Xss1024k` | Instructs the JVM to limit the stack size to 1MB
| `-XX:+UseG1GC` | Instructs the JVM to use the new G1 (Garbage First) Garbage Collector. As of Java9 this will be the default GC.
| `-Dsun.net.inetaddr.ttl=60` |
| `-XX:+HeapDumpOnOutOfMemoryError` | Instructs the JVM to dump the heap to a file in case of an OutOfMemoryError. This is useful for debugging purposes after the XL Release process has crashed.
| `-XX:HeapDumpPath=log/` | Instructs the JVM to store the generated heap dumps to the `log/` directory of the XL Release server.
|===

=== Monitoring
Hardware monitoring and alerting
- Network
- Disk
- RAM
- CPU

Product monitoring


Database monitoring
